<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Buscar y Editar Cliente</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .container { margin-top: 40px; }
        .form-inline .form-control { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Buscar Clientes</h2>
        <form id="buscarForm" class="form-inline mb-4">
            <input type="text" class="form-control" placeholder="Nombre" name="nombre">
            <input type="text" class="form-control" placeholder="Correo" name="correo">
            <input type="text" class="form-control" placeholder="Teléfono" name="telefono">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>

        <table class="table table-bordered" id="resultados">
            <thead>
                <tr>
                    <th>Nombre</th><th>Apellido</th><th>Correo</th><th>Teléfono</th><th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal para editar -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" id="formEditar">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="editId">
                    <input type="text" class="form-control mb-2" placeholder="Nombre" id="editNombre">
                    <input type="text" class="form-control mb-2" placeholder="Apellido" id="editApellido">
                    <input type="email" class="form-control mb-2" placeholder="Correo" id="editCorreo">
                    <input type="text" class="form-control mb-2" placeholder="Teléfono" id="editTelefono">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Guardar cambios</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const buscarForm = document.getElementById('buscarForm');
        const tablaBody = document.querySelector("#resultados tbody");
        const modal = new bootstrap.Modal(document.getElementById("modalEditar"));

        buscarForm.addEventListener('submit', async e => {
            e.preventDefault();
            tablaBody.innerHTML = "";
            const datos = new FormData(buscarForm);
            const params = new URLSearchParams(datos).toString();
            const res = await fetch(`/clientes/buscar?${params}`);
            const clientes = await res.json();
            clientes.forEach(c => {
                const fila = `<tr>
                    <td>${c.nombre}</td>
                    <td>${c.apellido}</td>
                    <td>${c.correo}</td>
                    <td>${c.telefono}</td>
                    <td><button class="btn btn-sm btn-warning" onclick='editar(${JSON.stringify(c)})'>Editar</button></td>
                </tr>`;
                tablaBody.innerHTML += fila;
            });
        });

        function editar(c) {
            document.getElementById("editId").value = c.id;
            document.getElementById("editNombre").value = c.nombre;
            document.getElementById("editApellido").value = c.apellido;
            document.getElementById("editCorreo").value = c.correo;
            document.getElementById("editTelefono").value = c.telefono;
            modal.show();
        }

        document.getElementById("formEditar").addEventListener("submit", async e => {
            e.preventDefault();
            const id = document.getElementById("editId").value;
            const datos = {
                nombre: document.getElementById("editNombre").value,
                apellido: document.getElementById("editApellido").value,
                correo: document.getElementById("editCorreo").value,
                telefono: document.getElementById("editTelefono").value
            };
            const res = await fetch(`/clientes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if (res.ok) {
                alert("Cliente actualizado correctamente");
                modal.hide();
                buscarForm.dispatchEvent(new Event("submit"));  // vuelve a buscar
            } else {
                const error = await res.json();
                alert("Error: " + error.error);
            }
        });
    </script>
</body>
</html>